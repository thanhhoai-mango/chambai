<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Web Ch·∫•m B√†i</title>
  <link rel="icon" type="image/png" href="check1.png" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #fdf4ff;
      color: #4b0082;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    h2 {
      color: #7e57c2;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section {
      background-color: #f3e5f5;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .section:hover {
      transform: translateY(-3px);
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #6a1b9a;
    }

    input[type="number"],
    input[type="text"] {
      padding: 8px 12px;
      border: 1px solid #ce93d8;
      border-radius: 10px;
      outline: none;
      width: 100%;
      margin-bottom: 10px;
      background-color: #f8eafc;
      color: #4a148c;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: #9c27b0;
      box-shadow: 0 0 0 2px rgba(156, 39, 176, 0.2);
    }

    td input[type="text"] {
      width: 80px;
      padding: 6px 10px;
      border: 1px solid #ce93d8;
      border-radius: 10px;
      background-color: #f8eafc;
      color: #4a148c;
      text-align: center;
      box-sizing: border-box;
      transition: all 0.3s;
    }

    #answerForm {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 10px;
    }

    .answer-table {
      flex: 1 1 300px;
      border-collapse: collapse;
      margin-bottom: 15px;
    }

    .answer-table th,
    .answer-table td {
      border: 1px solid #ce93d8;
      padding: 8px;
      text-align: center;
      background-color: #fce4ec;
      color: #6a1b9a;
    }

    .answer-table th {
      background-color: #e1bee7;
    }

    .correct-answer {
      font-size: 0.8em;
      color: #2e7d32;
      font-weight: bold;
    }

    input[type="file"] {
      display: none;
    }

    .file-upload {
      display: inline-block;
      padding: 8px 16px;
      background-color: #d1c4e9;
      border-radius: 12px;
      color: #4a148c;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }

    .file-upload:hover {
      background-color: #b39ddb;
      transform: translateY(-2px);
    }

    button {
      background-color: #ba68c8;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      background-color: #ab47bc;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ce93d8;
      padding: 10px;
      text-align: center;
      background-color: #fce4ec;
      color: #6a1b9a;
    }

    th {
      background-color: #e1bee7;
    }

    #result {
      margin-top: 20px;
      padding: 15px;
      background-color: #ede7f6;
      border-radius: 12px;
      font-weight: bold;
      color: #4a148c;
      display: none;
      align-items: center;
      gap: 10px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    #fileNameDisplay {
      margin-top: 10px;
      padding: 8px;
      background-color: #e1bee7;
      border-radius: 8px;
      display: inline-block;
    }

    .correct {
      background-color: #c8e6c9 !important;
    }

    .incorrect {
      background-color: #ffcdd2 !important;
    }

    .error-message {
      color: #d32f2f;
      font-weight: bold;
      margin-top: 5px;
    }

    .ggsheet-section {
      margin-top: 15px;
      padding: 15px;
      background-color: #e3f2fd;
      border-radius: 10px;
    }
    
    .ggsheet-input {
      width: calc(100% - 24px);
      padding: 8px 12px;
      border: 1px solid #90caf9;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .sync-info {
      font-size: 0.9em;
      color: #0d47a1;
      margin-top: 5px;
    }
    
    .last-sync {
      font-size: 0.8em;
      color: #546e7a;
      margin-top: 5px;
    }

  </style>
</head>
<body>
  <div class="section">
    <h2><i class="fas fa-edit"></i> üìù Ph·∫ßn B√†i L√†m</h2>
    <label for="numQuestions">üî¢ S·ªë c√¢u h·ªèi:</label>
    <input type="number" id="numQuestions" min="1" placeholder="Nh·∫≠p s·ªë c√¢u" />
    <div class="button-group">
      <button onclick="generateAnswerSheet()"><i class="fas fa-table"></i> ‚ú® T·∫°o b·∫£ng</button>
      <button onclick="resetForm()" style="background-color: #f44336;"><i class="fas fa-redo"></i> üîÑ Reset</button>
    </div>
    <form id="answerForm"></form>
  </div>

  <div class="section">
    <h2><i class="fas fa-file-import"></i> üì• Ph·∫ßn ƒê√°p √Ån</h2>

    <label class="file-upload">
      <i class="fas fa-upload"></i> Ch·ªçn file Excel
      <input type="file" id="excelFile" accept=".xlsx, .xls" />
    </label>

    <div id="fileNameDisplay"></div>
    <div id="excelError" class="error-message"></div>

    <h2 style="margin-top: 30px;">üåê D√°n link Google Sheet</h2>
    <input type="text" id="sheetLink" placeholder="D√°n link Google Sheet" style="width: 60%;" />
    <button onclick="loadData()">T·∫£i d·ªØ li·ªáu</button>

    <div id="sheetData"></div>

    <div style="margin-top: 10px">
      <label for="pointPerCorrect">üéØ ƒêi·ªÉm m·ªói c√¢u ƒë√∫ng:</label>
      <input type="number" id="pointPerCorrect" value="1" step="0.1" min="0.1" placeholder="VD: 0.5, 1..." />
    </div>
    <div class="button-group">
      <button onclick="generateCorrectAnswerTable()"><i class="fas fa-table"></i> üìã T·∫°o b·∫£ng ƒë√°p √°n</button>
      <button onclick="gradeAnswers()"><i class="fas fa-check-circle"></i> ‚úÖ Ch·∫•m b√†i</button>
      <button onclick="exportResults()"><i class="fas fa-file-export"></i> üì§ Xu·∫•t k·∫øt qu·∫£ Excel</button>
    </div>
    <form id="correctAnswerForm" style="margin-top: 10px;"></form>

    <div id="result"><i class="fas fa-chart-line"></i> <span id="resultText"></span></div>
  </div>

  <script>
    let correctAnswers = {};
    
    function resetForm() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset to√†n b·ªô d·ªØ li·ªáu?')) {
        document.getElementById('numQuestions').value = '';
        document.getElementById('answerForm').innerHTML = '';
        document.getElementById('correctAnswerForm').innerHTML = '';
        document.getElementById('excelFile').value = '';
        document.getElementById('fileNameDisplay').textContent = '';
        document.getElementById('result').style.display = 'none';
        document.getElementById('excelError').textContent = '';
        correctAnswers = {};
      }
    }

    function generateAnswerSheet() {
      const form = document.getElementById('answerForm');
      const num = parseInt(document.getElementById('numQuestions').value);
      
      if (!num || num <= 0) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë c√¢u h·ªèi h·ª£p l·ªá (l·ªõn h∆°n 0)");
        return;
      }
      
      form.innerHTML = '';

      const table = document.createElement('table');
      table.className = 'answer-table';

      const sttRow = document.createElement('tr');
      const ansRow = document.createElement('tr');
      const correctAnsRow = document.createElement('tr');

      let count = 0;

      for (let i = 1; i <= num; i++) {
        const sttCell = document.createElement('td');
        sttCell.textContent = i;
        sttRow.appendChild(sttCell);

        const ansCell = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.name = `answer_${i}`;
        input.maxLength = 10;
        input.placeholder = 'Nh·∫≠p ƒë√°p √°n';
        ansCell.appendChild(input);
        ansRow.appendChild(ansCell);

        const correctAnsCell = document.createElement('td');
        correctAnsCell.className = 'correct-answer';
        correctAnsCell.id = `correctAnswer_${i}`;
        correctAnsRow.appendChild(correctAnsCell);

        count++;

        if (count === 5 || i === num) {
          table.appendChild(sttRow.cloneNode(true));
          table.appendChild(ansRow.cloneNode(true));
          table.appendChild(correctAnsRow.cloneNode(true));
          count = 0;
          sttRow.innerHTML = '';
          ansRow.innerHTML = '';
          correctAnsRow.innerHTML = '';
        }
      }

      form.appendChild(table);
      updateCorrectAnswerDisplay();
    }

    document.getElementById('excelFile').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) return;

  document.getElementById('fileNameDisplay').textContent = `üìÇ ƒê√£ ch·ªçn: ${file.name}`;
  document.getElementById('excelError').textContent = '';
  const reader = new FileReader();

  reader.onload = function (e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      parseData(json);
      alert(`‚úÖ ƒê√£ t·∫£i ${Object.keys(correctAnswers).length} ƒë√°p √°n t·ª´ file Excel`);
    } catch (error) {
      console.error('L·ªói khi ƒë·ªçc file Excel:', error);
      document.getElementById('excelError').textContent = '‚ö†Ô∏è L·ªói khi ƒë·ªçc file Excel. Vui l√≤ng ki·ªÉm tra l·∫°i file.';
    }
  };

  reader.onerror = function () {
    document.getElementById('excelError').textContent = '‚ö†Ô∏è L·ªói khi ƒë·ªçc file. Vui l√≤ng th·ª≠ l·∫°i.';
  };

  reader.readAsArrayBuffer(file);
});

function loadData() {
  document.getElementById('excelError').textContent = '';
  const sheetLink = document.getElementById('sheetLink').value.trim();

  if (sheetLink) {
    fetch(sheetLink)
      .then(res => {
        if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i file CSV.');
        return res.text();
      })
      .then(csvText => {
        // ƒê∆°n gi·∫£n parse CSV th√†nh m·∫£ng 2 chi·ªÅu
        const rows = csvText.trim().split('\n').map(row => {
          // X·ª≠ l√Ω ƒë∆°n gi·∫£n, t√°ch theo d·∫•u ph·∫©y
          // N·∫øu c·∫ßn n√¢ng cao, c√≥ th·ªÉ d√πng th∆∞ vi·ªán CSV parser
          return row.split(',');
        });
        parseData(rows);
        alert(`‚úÖ ƒê√£ t·∫£i ${Object.keys(correctAnswers).length} ƒë√°p √°n t·ª´ Google Sheet CSV`);
      })
      .catch(err => {
        console.error(err);
        document.getElementById('excelError').textContent = '‚ö†Ô∏è L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ link Google Sheet.';
      });
  } else {
    document.getElementById('excelError').textContent = '‚ö†Ô∏è Vui l√≤ng nh·∫≠p link Google Sheet CSV ho·∫∑c ch·ªçn file Excel.';
  }
}

// H√†m d√πng chung parse d·ªØ li·ªáu Excel ho·∫∑c CSV
function parseData(json) {
  correctAnswers = {};
  let formatDetected = '';

  if (json.length === 0) {
    document.getElementById('excelError').textContent = '‚ö†Ô∏è D·ªØ li·ªáu tr·ªëng.';
    return;
  }

  // KI·ªÇM TRA ƒê·ªäNH D·∫†NG NGANG (d√≤ng 1 l√† s·ªë c√¢u, d√≤ng 2 l√† ƒë√°p √°n)
  if (json.length >= 2) {
    const questionRow = json[0];
    const answerRow = json[1];

    let validPairs = 0;
    let isHorizontalFormat = true;

    for (let i = 0; i < Math.max(questionRow.length, answerRow.length); i++) {
      const qNum = questionRow[i];
      const ans = answerRow[i];

      const isQNumValid = typeof qNum === 'number' || !isNaN(parseInt(qNum));
      const isAnsValid = typeof ans === 'string' && /^[A-Z]$/i.test(ans.toUpperCase());

      if (isQNumValid && isAnsValid) {
        correctAnswers[qNum.toString().trim()] = ans.toString().trim().toUpperCase();
        validPairs++;
      } else if (qNum || ans) {
        isHorizontalFormat = false;
        break;
      }
    }

    if (isHorizontalFormat && validPairs >= 3) {
      formatDetected = 'ngang (d√≤ng 1 l√† s·ªë c√¢u, d√≤ng 2 l√† ƒë√°p √°n)';
    } else {
      correctAnswers = {};
    }
  }

  // KI·ªÇM TRA ƒê·ªäNH D·∫†NG D·ªåC (t·ª± ƒë·ªông nh·∫≠n bi·∫øt c√≥ ti√™u ƒë·ªÅ hay kh√¥ng)
  if (!formatDetected) {
    let startRow = 0;
    if (json[0] && typeof json[0][0] === 'string' && json[0][0].toLowerCase().includes('c√¢u')) {
      startRow = 1;
    }

    for (let i = startRow; i < json.length; i++) {
      const row = json[i];
      if (!row || row.length < 2 || !row[0] || row[0].toString().trim() === '') continue;

      const qNum = row[0].toString().trim();
      const ans = row[1] ? row[1].toString().trim().toUpperCase() : '';

      if (qNum && ans) {
        correctAnswers[qNum] = ans;
      }
    }

    if (Object.keys(correctAnswers).length > 0) {
      formatDetected = 'd·ªçc (m·ªói d√≤ng l√† 1 c√¢u h·ªèi v√† ƒë√°p √°n)';
    }
  }

  if (!formatDetected) {
    document.getElementById('excelError').textContent = '‚ö†Ô∏è Kh√¥ng nh·∫≠n d·∫°ng ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng d·ªØ li·ªáu.';
    return;
  }

  console.log('üì¶ ƒê√°p √°n t·∫£i ƒë∆∞·ª£c:', correctAnswers);
}

    function gradeAnswers() {
  let correct = 0;
  let total = 0;
  let totalScore = 0;
  const pointPerCorrect = parseFloat(document.getElementById('pointPerCorrect').value) || 1;
  const numQuestions = parseInt(document.getElementById('numQuestions').value);

  // L·∫•y ƒë√°p √°n t·ª´ b·∫£ng nh·∫≠p tay (n·∫øu c√≥)
  for (let i = 1; i <= numQuestions; i++) {
    const input = document.getElementById(`correct_${i}`);
    if (input && input.value.trim() !== '') {
      correctAnswers[i.toString()] = input.value.trim().toUpperCase();
    }
  }

  // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë√°p √°n ƒë√∫ng
  updateCorrectAnswerDisplay();

  // So s√°nh t·ª´ng c√¢u tr·∫£ l·ªùi
  for (let i = 1; i <= numQuestions; i++) {
    const qNum = i.toString();
    const answerInput = document.querySelector(`input[name="answer_${qNum}"]`);
    const correctAns = correctAnswers[qNum];
    const correctAnswerCell = document.getElementById(`correctAnswer_${qNum}`);

    if (answerInput && correctAns) {
      total++;
      const userAns = answerInput.value.trim().toUpperCase();

      // Reset class tr∆∞·ªõc khi ki·ªÉm tra
      answerInput.classList.remove('correct', 'incorrect');
      if (correctAnswerCell) correctAnswerCell.classList.remove('correct', 'incorrect');

      if (userAns === correctAns) {
        answerInput.classList.add('correct');
        if (correctAnswerCell) correctAnswerCell.classList.add('correct');
        correct++;
        totalScore += pointPerCorrect;
      } else {
        answerInput.classList.add('incorrect');
        if (correctAnswerCell) correctAnswerCell.classList.add('incorrect');
      }
    }
  }

  // Hi·ªÉn th·ªã k·∫øt qu·∫£
  const resultBox = document.getElementById('result');
  const resultText = document.getElementById('resultText');

  if (total === 0) {
    resultText.textContent = '‚ö†Ô∏è Kh√¥ng c√≥ c√¢u h·ªèi ƒë·ªÉ ch·∫•m.';
  } else {
    const percentage = ((correct / total) * 100).toFixed(2);
    resultText.innerHTML = `
      B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng <b>${correct}</b> tr√™n <b>${total}</b> c√¢u.<br>
      T·ªïng ƒëi·ªÉm: <span style="color: green; font-weight: bold;">${totalScore.toFixed(1)} ƒëi·ªÉm</span>.<br>
      T·ª∑ l·ªá: <span style="color: blue;">${percentage}%</span> `;
  }

  resultBox.style.display = 'flex';
}


    function generateCorrectAnswerTable() {
      const form = document.getElementById('correctAnswerForm');
      const num = parseInt(document.getElementById('numQuestions').value);
      
      if (!num || num <= 0) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë c√¢u h·ªèi h·ª£p l·ªá tr∆∞·ªõc!");
        return;
      }

      form.innerHTML = '';

      const table = document.createElement('table');
      table.className = 'answer-table';

      let sttRow = document.createElement('tr');
      let ansRow = document.createElement('tr');

      let count = 0;

      for (let i = 1; i <= num; i++) {
        const sttCell = document.createElement('td');
        sttCell.textContent = i;
        sttRow.appendChild(sttCell);

        const ansCell = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.id = `correct_${i}`;
        input.maxLength = 10;
        input.placeholder = 'Nh·∫≠p ƒë√°p √°n';
        input.value = correctAnswers[i] || '';
        ansCell.appendChild(input);
        ansRow.appendChild(ansCell);

        count++;

        if (count === 5 || i === num) {
          table.appendChild(sttRow);
          table.appendChild(ansRow);
          sttRow = document.createElement('tr');
          ansRow = document.createElement('tr');
          count = 0;
        }
      }

      form.appendChild(table);
    }

    // ========== EXPORT K·∫æT QU·∫¢ ==========
    function exportResults() {
      const numQuestions = parseInt(document.getElementById('numQuestions').value);
      if (!numQuestions || numQuestions <= 0) {
        alert('Vui l√≤ng nh·∫≠p s·ªë c√¢u h·ªèi h·ª£p l·ªá tr∆∞·ªõc khi xu·∫•t k·∫øt qu·∫£');
        return;
      }

      // T·∫°o d·ªØ li·ªáu cho Excel
      const data = [
        ['C√¢u h·ªèi', 'ƒê√°p √°n HS', 'ƒê√°p √°n ƒë√∫ng', 'K·∫øt qu·∫£']
      ];

      let correctCount = 0;
      const pointPerCorrect = parseFloat(document.getElementById('pointPerCorrect').value) || 1;

      for (let i = 1; i <= numQuestions; i++) {
        const qNum = i.toString();
        const answerInput = document.querySelector(`input[name="answer_${qNum}"]`);
        const correctAns = correctAnswers[qNum];
        const userAns = answerInput ? answerInput.value.trim().toUpperCase() : '';
        
        let result = '';
        if (correctAns) {
          if (userAns === correctAns) {
            result = 'ƒê√∫ng';
            correctCount++;
          } else {
            result = 'Sai';
          }
        }

        data.push([
          qNum,
          userAns,
          correctAns || '',
          result
        ]);
      }

      // T√≠nh t·ªïng ƒëi·ªÉm
      const totalScore = (correctCount * pointPerCorrect).toFixed(1);
      data.push([], ['T·ªïng c√¢u ƒë√∫ng', correctCount], ['T·ªïng ƒëi·ªÉm', totalScore]);

      // T·∫°o workbook
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "K·∫øt qu·∫£ ch·∫•m b√†i");

      // Xu·∫•t file
      const fileName = `KetQuaChamBai_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }
    
    function updateCorrectAnswerDisplay() {
  for (const qNum in correctAnswers) {
    const correctAnswerCell = document.getElementById(`correctAnswer_${qNum}`);
    if (correctAnswerCell) {
      correctAnswerCell.textContent = correctAnswers[qNum];
    }
  }
}

  </script>
</body>
</html>
